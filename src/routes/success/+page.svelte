<script lang="ts">
  import "@fontsource/manrope";
  import { onMount } from "svelte";
  import { PUBLIC_BOOKINGS_URL, PUBLIC_PAYMENTS_URL, PUBLIC_ANALYTICS_URL } from "$env/static/public";
  import JoinUsButton from "../../components/joinUsButton.svelte";
  import { goto } from "$app/navigation";

  export let data;
  let email_confirmation;

  let basketItems = data.basket.items;
  let prices : any = data.basket.prices;
  let user = data.user;

  let itemWorkingCopy = basketItems;
  let pricesWorkingCopy = prices;

  function createBookings() {
    let item = itemWorkingCopy[0];
    let price = pricesWorkingCopy[0];
    let userId = localStorage.getItem("uid");
    let facilitiesId = item.facilityId;
    let bookingDate = item.bookingDate;
    let bookingTime = item.bookingTime;
    let bookingLength = item.bookingLength;
    let activityId = item.activityId;

    const res = fetch(PUBLIC_BOOKINGS_URL + "booking", {
      method: "POST",
      // essential to set the header
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        userId,
        facilityId: facilitiesId,
        activityId: activityId,
        bookingDate: bookingDate,
        bookingTime: bookingTime,
        bookingLength
      })
    }).then((result) =>{

      // Create sale record in the analytics API
      const recordSaleRequest = fetch(PUBLIC_ANALYTICS_URL + "sales", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          saleValue: price,
          facilityId: facilitiesId,
          activityId: activityId
        })
      }).then((result) => {
        console.log(result);
        pricesWorkingCopy.shift();
      })

      if (result.status) {
        //if 200...
        itemWorkingCopy.shift();

        if (itemWorkingCopy.length > 0) {
          setTimeout(createBookings, 500);
        } else {
          const res = fetch(PUBLIC_PAYMENTS_URL + "basket/" + user._id, {
            method: "DELETE",
            // essential to set the header
            headers: {
              "Content-Type": "application/json",
            },
          });
        }
      }
    });
  }


  async function successEmail() {
    // Make a POST request to the confirmation email endpoint
    const res2 = await fetch(PUBLIC_BOOKINGS_URL + `/emails/confirmation/`+user.email, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      }
    })
    // The data returned by get_all_activities() endpoint in the Bookings API
    email_confirmation = await res2.json()

    if (email_confirmation === "Sent") {
      console.log("The message was sent")
    } else {
      console.log("The message was not sent")
    }
  }


  onMount(() => {
    createBookings();
    successEmail();
  });
</script>

<div class="p-16">
  <svg
    width="200"
    height="52"
    viewBox="0 0 212 52"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M49.088 38.54C47.072 38.54 45.344 38.09 43.904 37.19C42.464 36.29 41.36 35.066 40.592 33.518C39.824 31.97 39.44 30.224 39.44 28.28C39.44 26.312 39.836 24.554 40.628 23.006C41.432 21.458 42.56 20.24 44.012 19.352C45.464 18.464 47.18 18.02 49.16 18.02C51.452 18.02 53.372 18.602 54.92 19.766C56.48 20.918 57.476 22.496 57.908 24.5L53.012 25.796C52.724 24.788 52.22 24.002 51.5 23.438C50.792 22.874 49.988 22.592 49.088 22.592C48.056 22.592 47.21 22.844 46.55 23.348C45.89 23.84 45.404 24.518 45.092 25.382C44.78 26.234 44.624 27.2 44.624 28.28C44.624 29.972 44.996 31.346 45.74 32.402C46.496 33.446 47.612 33.968 49.088 33.968C50.192 33.968 51.032 33.716 51.608 33.212C52.184 32.708 52.616 31.988 52.904 31.052L57.908 32.096C57.356 34.16 56.312 35.75 54.776 36.866C53.24 37.982 51.344 38.54 49.088 38.54ZM61.3409 38V11.54H66.2369V38H61.3409ZM80.6693 38.54C78.6773 38.54 76.9193 38.114 75.3953 37.262C73.8833 36.398 72.6953 35.216 71.8313 33.716C70.9793 32.204 70.5533 30.476 70.5533 28.532C70.5533 26.408 70.9733 24.56 71.8133 22.988C72.6533 21.416 73.8113 20.198 75.2873 19.334C76.7633 18.458 78.4613 18.02 80.3813 18.02C82.4213 18.02 84.1553 18.5 85.5833 19.46C87.0113 20.42 88.0673 21.77 88.7513 23.51C89.4353 25.25 89.6753 27.296 89.4713 29.648H84.6293V27.848C84.6293 25.868 84.3113 24.446 83.6753 23.582C83.0513 22.706 82.0253 22.268 80.5973 22.268C78.9293 22.268 77.6993 22.778 76.9073 23.798C76.1273 24.806 75.7373 26.3 75.7373 28.28C75.7373 30.092 76.1273 31.496 76.9073 32.492C77.6993 33.476 78.8573 33.968 80.3813 33.968C81.3413 33.968 82.1633 33.758 82.8473 33.338C83.5313 32.918 84.0533 32.312 84.4133 31.52L89.3093 32.924C88.5773 34.7 87.4193 36.08 85.8353 37.064C84.2633 38.048 82.5413 38.54 80.6693 38.54ZM74.2253 29.648V26.012H87.1133V29.648H74.2253ZM98.5841 38.54C97.1921 38.54 96.0101 38.276 95.0381 37.748C94.0781 37.208 93.3461 36.494 92.8421 35.606C92.3501 34.706 92.1041 33.716 92.1041 32.636C92.1041 31.736 92.2421 30.914 92.5181 30.17C92.7941 29.426 93.2381 28.772 93.8501 28.208C94.4741 27.632 95.3081 27.152 96.3521 26.768C97.0721 26.504 97.9301 26.27 98.9261 26.066C99.9221 25.862 101.05 25.67 102.31 25.49C103.57 25.298 104.956 25.088 106.468 24.86L104.704 25.832C104.704 24.68 104.428 23.834 103.876 23.294C103.324 22.754 102.4 22.484 101.104 22.484C100.384 22.484 99.6341 22.658 98.8541 23.006C98.0741 23.354 97.5281 23.972 97.2161 24.86L92.7881 23.456C93.2801 21.848 94.2041 20.54 95.5601 19.532C96.9161 18.524 98.7641 18.02 101.104 18.02C102.82 18.02 104.344 18.284 105.676 18.812C107.008 19.34 108.016 20.252 108.7 21.548C109.084 22.268 109.312 22.988 109.384 23.708C109.456 24.428 109.492 25.232 109.492 26.12V38H105.208V34.004L105.82 34.832C104.872 36.14 103.846 37.088 102.742 37.676C101.65 38.252 100.264 38.54 98.5841 38.54ZM99.6281 34.688C100.528 34.688 101.284 34.532 101.896 34.22C102.52 33.896 103.012 33.53 103.372 33.122C103.744 32.714 103.996 32.372 104.128 32.096C104.38 31.568 104.524 30.956 104.56 30.26C104.608 29.552 104.632 28.964 104.632 28.496L106.072 28.856C104.62 29.096 103.444 29.3 102.544 29.468C101.644 29.624 100.918 29.768 100.366 29.9C99.8141 30.032 99.3281 30.176 98.9081 30.332C98.4281 30.524 98.0381 30.734 97.7381 30.962C97.4501 31.178 97.2341 31.418 97.0901 31.682C96.9581 31.946 96.8921 32.24 96.8921 32.564C96.8921 33.008 97.0001 33.392 97.2161 33.716C97.4441 34.028 97.7621 34.268 98.1701 34.436C98.5781 34.604 99.0641 34.688 99.6281 34.688ZM114.172 38V18.56H118.492V23.312L118.024 22.7C118.276 22.028 118.612 21.416 119.032 20.864C119.452 20.312 119.968 19.856 120.58 19.496C121.048 19.208 121.558 18.986 122.11 18.83C122.662 18.662 123.232 18.56 123.82 18.524C124.408 18.476 124.996 18.488 125.584 18.56V23.132C125.044 22.964 124.414 22.91 123.694 22.97C122.986 23.018 122.344 23.18 121.768 23.456C121.192 23.72 120.706 24.074 120.31 24.518C119.914 24.95 119.614 25.466 119.41 26.066C119.206 26.654 119.104 27.32 119.104 28.064V38H114.172ZM136.621 47.18C135.517 47.18 134.467 47 133.471 46.64C132.475 46.292 131.581 45.8 130.789 45.164C130.009 44.54 129.373 43.808 128.881 42.968L133.417 40.772C133.729 41.348 134.173 41.786 134.749 42.086C135.337 42.386 135.973 42.536 136.657 42.536C137.389 42.536 138.079 42.41 138.727 42.158C139.375 41.918 139.891 41.552 140.275 41.06C140.671 40.58 140.857 39.98 140.833 39.26V33.608H141.445V18.56H145.729V39.332C145.729 39.812 145.705 40.262 145.657 40.682C145.621 41.114 145.549 41.54 145.441 41.96C145.129 43.148 144.547 44.126 143.695 44.894C142.855 45.662 141.823 46.232 140.599 46.604C139.375 46.988 138.049 47.18 136.621 47.18ZM136.189 38.54C134.401 38.54 132.835 38.09 131.491 37.19C130.147 36.29 129.097 35.066 128.341 33.518C127.597 31.97 127.225 30.224 127.225 28.28C127.225 26.3 127.603 24.542 128.359 23.006C129.127 21.458 130.201 20.24 131.581 19.352C132.961 18.464 134.581 18.02 136.441 18.02C138.289 18.02 139.843 18.47 141.103 19.37C142.363 20.27 143.317 21.494 143.965 23.042C144.613 24.59 144.937 26.336 144.937 28.28C144.937 30.224 144.607 31.97 143.947 33.518C143.299 35.066 142.327 36.29 141.031 37.19C139.735 38.09 138.121 38.54 136.189 38.54ZM136.981 34.184C138.073 34.184 138.943 33.938 139.591 33.446C140.251 32.954 140.725 32.264 141.013 31.376C141.301 30.488 141.445 29.456 141.445 28.28C141.445 27.104 141.301 26.072 141.013 25.184C140.725 24.296 140.263 23.606 139.627 23.114C139.003 22.622 138.181 22.376 137.161 22.376C136.069 22.376 135.169 22.646 134.461 23.186C133.765 23.714 133.249 24.428 132.913 25.328C132.577 26.216 132.409 27.2 132.409 28.28C132.409 29.372 132.571 30.368 132.895 31.268C133.219 32.156 133.717 32.864 134.389 33.392C135.061 33.92 135.925 34.184 136.981 34.184ZM153.254 46.64L156.998 36.344L157.07 39.368L148.61 18.56H153.686L159.374 33.284H158.222L163.874 18.56H168.77L157.79 46.64H153.254ZM194.701 38V26.516C194.701 25.232 194.395 24.236 193.783 23.528C193.183 22.808 192.349 22.448 191.281 22.448C190.597 22.448 190.003 22.61 189.499 22.934C188.995 23.246 188.599 23.69 188.311 24.266C188.035 24.83 187.897 25.484 187.897 26.228L185.845 24.86C185.845 23.528 186.157 22.352 186.781 21.332C187.417 20.312 188.263 19.52 189.319 18.956C190.387 18.38 191.569 18.092 192.865 18.092C195.085 18.092 196.759 18.752 197.887 20.072C199.027 21.38 199.597 23.096 199.597 25.22V38H194.701ZM171.265 38V18.56H175.585V25.004H176.197V38H171.265ZM183.001 38V26.516C183.001 25.232 182.695 24.236 182.083 23.528C181.483 22.808 180.649 22.448 179.581 22.448C178.561 22.448 177.739 22.802 177.115 23.51C176.503 24.206 176.197 25.112 176.197 26.228L174.145 24.788C174.145 23.516 174.463 22.376 175.099 21.368C175.735 20.36 176.587 19.562 177.655 18.974C178.735 18.386 179.941 18.092 181.273 18.092C182.797 18.092 184.045 18.416 185.017 19.064C186.001 19.712 186.727 20.576 187.195 21.656C187.663 22.736 187.897 23.924 187.897 25.22V38H183.001Z"
      fill="#0369A1"
    />
    <path
      fill-rule="evenodd"
      clip-rule="evenodd"
      d="M168.392 19.3561H164C164 15.8457 166.622 13 169.856 13C173.09 13 175.712 15.8457 175.712 19.3561H171.32C171.32 18.4785 170.665 17.7671 169.856 17.7671C169.048 17.7671 168.392 18.4785 168.392 19.3561Z"
      fill="#0369A1"
    />
    <path
      d="M13.5025 28.5H19.4975M30.9375 31.9375V25.0625M2.0625 31.9375V25.0625M23.6225 36.75C26.9225 36.75 27.7475 34.8937 27.7475 32.625V24.375C27.7475 22.1063 26.9225 20.25 23.6225 20.25C20.3225 20.25 19.4975 22.1063 19.4975 24.375V32.625C19.4975 34.8937 20.3225 36.75 23.6225 36.75ZM9.3775 36.75C6.0775 36.75 5.2525 34.8937 5.2525 32.625V24.375C5.2525 22.1063 6.0775 20.25 9.3775 20.25C12.6775 20.25 13.5025 22.1063 13.5025 24.375V32.625C13.5025 34.8937 12.6775 36.75 9.3775 36.75Z"
      stroke="#0369A1"
      stroke-width="2.5"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </svg>
  <div class="flex flex-row">
    <p class="font-bold text-5xl text-[#1A1A1A] pl-20 pr-3 mt-20">
      Payment Successful
    </p>
    <svg
      class="mt-20"
      width="60"
      height="60"
      viewBox="0 0 70 70"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M44.8535 5.33337H19.1468C13.4668 5.33337 8.85352 9.97337 8.85352 15.6267V53.2C8.85352 58 12.2935 60.0267 16.5068 57.7067L29.5202 50.48C30.9068 49.7067 33.1468 49.7067 34.5068 50.48L47.5202 57.7067C51.7335 60.0534 55.1735 58.0267 55.1735 53.2V15.6267C55.1469 9.97337 50.5335 5.33337 44.8535 5.33337Z"
        stroke="#2CA103"
        stroke-width="3"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <path
        d="M25.5732 29.3333L29.5732 33.3333L40.2399 22.6666"
        stroke="#2CA103"
        stroke-width="3"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </div>
  <p class="px-20 text-lg pt-2">
    Thank you for your payment! We have received your payment and it has been
    successfully processed. You will receive an email receipt shortly. If you
    have any questions or concerns, please don't hesitate to contact us.
  </p>
  <div class="flex flex-row pt-1 justify-center items-center">
    <img
      src="illustration2.jpg"
      alt="gym illustration"
      width="700"
      height="700"
    />
  </div>
  <div class="flex place-content-end">
    <JoinUsButton class="w-1/5 items-end" on:click={() => goto("/dashboard")}
      >Return to Dashboard</JoinUsButton
    >
  </div>
</div>

<style lang="postcss">
</style>
